From a2289727178005a404d8fd6e81b00d8f57418d87 Mon Sep 17 00:00:00 2001
From: "Uwe L. Korn" <uwelk@xhochy.com>
Date: Sun, 11 Feb 2024 20:18:13 +0100
Subject: [PATCH 3/3] xla: Fix abseil headers

---
 third_party/xla/0001-Fix-abseil-headers.patch | 73 +++++++++++++++++++
 third_party/xla/workspace.bzl                 |  1 +
 2 files changed, 74 insertions(+)
 create mode 100644 third_party/xla/0001-Fix-abseil-headers.patch

diff --git a/third_party/xla/0001-Fix-abseil-headers.patch b/third_party/xla/0001-Fix-abseil-headers.patch
new file mode 100644
index 0000000..8ca492c
--- /dev/null
+++ b/third_party/xla/0001-Fix-abseil-headers.patch
@@ -0,0 +1,73 @@
+From f7f47d5057a1595cfa2bdbcc9db9ba1ac04dac15 Mon Sep 17 00:00:00 2001
+From: "Uwe L. Korn" <uwe.korn@quantco.com>
+Date: Thu, 23 May 2024 15:45:52 +0200
+Subject: [PATCH 2/2] Fix abseil headers
+
+---
+ third_party/tsl/tsl/platform/default/BUILD    | 2 ++
+ third_party/tsl/tsl/profiler/rpc/client/BUILD | 4 ++++
+ xla/python/ifrt_proxy/common/BUILD            | 3 +++
+ xla/tsl/distributed_runtime/rpc/BUILD         | 1 +
+ 4 files changed, 10 insertions(+)
+
+diff --git a/third_party/tsl/tsl/platform/default/BUILD b/third_party/tsl/tsl/platform/default/BUILD
+index 5adfc6b58d..34387f9a25 100644
+--- a/third_party/tsl/tsl/platform/default/BUILD
++++ b/third_party/tsl/tsl/platform/default/BUILD
+@@ -220,6 +220,8 @@ cc_library(
+     deps = [
+         "//tsl/platform:logging",
+         "@com_google_absl//absl/log:check",
++        "@com_google_absl//absl/status",
++        "@com_google_absl//absl/status:statusor",
+     ] + tsl_grpc_cc_dependencies(),
+ )
+ 
+diff --git a/third_party/tsl/tsl/profiler/rpc/client/BUILD b/third_party/tsl/tsl/profiler/rpc/client/BUILD
+index 03f8c1deff..1f081a14d1 100644
+--- a/third_party/tsl/tsl/profiler/rpc/client/BUILD
++++ b/third_party/tsl/tsl/profiler/rpc/client/BUILD
+@@ -101,6 +101,8 @@ cc_library(
+         "//tsl/platform:status",
+         "//tsl/profiler/protobuf:profiler_analysis_cc_grpc_proto",
+         "//tsl/profiler/protobuf:profiler_service_cc_grpc_proto",
++        "@com_google_absl//absl/status",
++        "@com_google_absl//absl/status:statusor",
+         "@com_google_absl//absl/strings",
+         "@com_google_absl//absl/time",
+     ],
+@@ -127,6 +129,8 @@ cc_library(
+         "//tsl/platform:types",
+         "//tsl/profiler/protobuf:profiler_analysis_cc_grpc_proto",
+         "//tsl/profiler/protobuf:profiler_service_cc_grpc_proto",
++        "@com_google_absl//absl/status",
++        "@com_google_absl//absl/status:statusor",
+         "//tsl/protobuf:error_codes_proto_impl_cc",
+         "@com_google_absl//absl/memory",
+         "@com_google_absl//absl/strings",
+diff --git a/xla/python/ifrt_proxy/common/BUILD b/xla/python/ifrt_proxy/common/BUILD
+index 257f813a5f..65abf54caf 100644
+--- a/xla/python/ifrt_proxy/common/BUILD
++++ b/xla/python/ifrt_proxy/common/BUILD
+@@ -52,6 +52,9 @@ cc_library(
+         "@com_github_grpc_grpc//:grpc++",
+         "@com_google_absl//absl/log",
+         "@com_google_absl//absl/log:check",
++        "@com_google_absl//absl/status",
++        "@com_google_absl//absl/status:statusor",
++        "@com_google_absl//absl/strings",
+         "@tsl//tsl/platform",
+     ],
+     alwayslink = True,
+diff --git a/xla/tsl/distributed_runtime/rpc/BUILD b/xla/tsl/distributed_runtime/rpc/BUILD
+index 0f9a93eb1a..e5f11fa62c 100644
+--- a/xla/tsl/distributed_runtime/rpc/BUILD
++++ b/xla/tsl/distributed_runtime/rpc/BUILD
+@@ -37,6 +37,7 @@ cc_library(
+     hdrs = ["grpc_util.h"],
+     deps = [
+         "@com_google_absl//absl/status",
++        "@com_google_absl//absl/status:statusor",
+         "@com_google_absl//absl/strings:cord",
+         "@tsl//tsl/platform:protobuf",
+         "@tsl//tsl/platform:status",
diff --git a/third_party/xla/workspace.bzl b/third_party/xla/workspace.bzl
index 1471b46..7b7ca42 100644
--- a/third_party/xla/workspace.bzl
+++ b/third_party/xla/workspace.bzl
@@ -31,6 +31,7 @@ def repo():
         urls = tf_mirror_urls("https://github.com/openxla/xla/archive/{commit}.tar.gz".format(commit = XLA_COMMIT)),
         patch_file = [
             "//third_party/xla:0001-Support-third-party-build-of-boringssl.patch",
+            "//third_party/xla:0001-Fix-abseil-headers.patch",
         ],
     )
 
